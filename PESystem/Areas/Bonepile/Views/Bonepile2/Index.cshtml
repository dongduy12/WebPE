@{
    ViewData["Title"] = "Bonepile";
    Layout = "~/Areas/Bonepile/Views/Shared/_Layout_Bonepile.cshtml";
}

<div class="dashboard-stage">
    <div class="dashboard-wrapper">
        <header class="dashboard-header">
            <div class="filter-grid">
                <div class="filter-field">
                    <label for="startDate">Từ ngày</label>
                    <input type="datetime-local" id="startDate" value="2025-03-16T11:00" />
                </div>
                <div class="filter-field">
                    <label for="endDate">Đến ngày</label>
                    <input type="datetime-local" id="endDate" />
                </div>
                <div class="filter-actions">
                    <button id="applyFilters" class="primary-btn">Áp dụng</button>
                </div>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="dashboard-left">
                <div class="data-card chart-card">
                    <div class="panel-title">Phân Bố Trạng Thái</div>
                    <div class="chart-container-lg">
                        <div id="statusDonutChart" class="echart-surface"></div>
                    </div>
                </div>
                <div class="data-card control-card">
                    <div class="panel-title">N/A</div>
                </div>
            </div>
            <div class="dashboard-right">
                <div class="data-card kpi-card">
                    @*<div class="panel-title">Thống Kê</div>*@
                    <div class="kpi-grid">
                        <div class="donut-box"><div class="donut-label">Bonepile 2.0</div><div class="donut-percent" id="totalCount">N/A</div></div>
                        <div class="donut-box"><div class="donut-label">WaitingApprovalScrap</div><div class="donut-percent" id="waitingScrapCount">N/A</div></div>
                        <div class="donut-box"><div class="donut-label">UnderRepair</div><div class="donut-percent" id="repairCount">N/A</div></div>
                        <div class="donut-box"><div class="donut-label">Online</div><div class="donut-percent" id="onlinePd">N/A</div></div>
                        <div class="donut-box"><div class="donut-label">KANBAN_IN</div><div class="donut-percent" id="kanbanIn">N/A</div></div>
                        <div class="donut-box"><div class="donut-label">Chờ Link</div><div class="donut-percent" id="waitingLink">N/A</div></div>
                        <div class="donut-box"><div class="donut-label">Chờ CheckOut</div><div class="donut-percent" id="waitingOut">N/A</div></div>
                        <div class="donut-box"><div class="donut-label">Chờ CheckIn</div><div class="donut-percent" id="waitingIn">N/A</div></div>
                        <div class="donut-box"><div class="donut-label">Đã Link</div><div class="donut-percent" id="linkedDone">N/A</div></div>
                        <div class="donut-box control-box">
                            <div class="donut-box-header">
                                <span class="donut-label">Nhập Kanban</span>
                                <button type="button" id="pickDateBtn" class="icon-btn" aria-label="Chọn thời gian">
                                    <i class="fa fa-calendar" aria-hidden="true"></i>
                                </button>
                            </div>
                            <div class="donut-percent" id="kanbanDone">N/A</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-card table-card">
            <div class="table-responsive">
                <table id="sumMaterialsTable" class="table table-bordered table-striped datatable-table" style="width:100%">
                    <div class="col-md-2">
                        <div class="status-filter-wrapper">
                            <select id="statusFilter" class="form-control">
                                <option value="">Tất cả trạng thái</option>
                                <option value="Repair">Repair</option>
                                <option value="CheckOut">CheckOut</option>
                                <option value="CheckIn">CheckIn</option>
                                <option value="WaitingLink">WaitingLink</option>
                                <option value="WaitingKanBanIn">WaitingKanBanIn</option>
                                <option value="Online">Online</option>
                                <option value="WaitingApproveScrap">WaitingApproveScrap</option>
                                <option value="Scrap">Scrap</option>
                            </select>
                        </div>
                    </div>
                    <thead>
                        <tr>
                            <th>SERIAL_NUMBER</th>
                            <th>PRODUCT_LINE</th>
                            <th>MODEL_NAME</th>
                            <th>MO_NUMBER</th>
                            <th>WIP_GROUP</th>
                            <th>FAIL_STATION</th>
                            <th>TEST_CODE</th>
                            <th>ERROR_DESC</th>
                            <th>TIME</th>
                            <th>FLAG</th>
                            <th>PO_NO</th>
                            <th>PO_ITEM</th>
                            <th>FAIL_AGING</th>
                            <th>VERSION_CODE</th>
                            <th>WORK_FLAG</th>
                            <th>ERROR_FLAG</th>
                            <th>MO_NEW</th>
                            <th>STATUS</th>
                            <th>CHECKIN_TIME</th>
                            <th>CHECKOUT_TIME</th>
                            <th>SCRAP_STATUS</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dateModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn khoảng thời gian</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="fromTime">Từ</label>
                <input type="datetime-local" id="fromTime" class="form-control mb-2" />
                <label for="toTime">Đến</label>
                <input type="datetime-local" id="toTime" class="form-control" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="applyDate">Áp dụng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/assets/areas/bonepile/js/bonepile2_0.js?v=@DateTime.Now.Ticks"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: radial-gradient(circle at 50% 0%, #f7faff 0%, #dfe9ff 60%);
            color: #1e2a45;
            font-family: "Segoe UI", "Roboto", Arial, sans-serif;
            min-height: 100vh;
            overflow-y: auto;
        }

        .dashboard-stage {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 2rem 0 3rem;
            overflow-x: hidden;
        }

        .dashboard-wrapper {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform-origin: top center;
            transition: transform 0.25s ease;
        }

        .dashboard-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .dashboard-header h1 {
            font-size: clamp(1.5rem, 2.4vw, 2.1rem);
            font-weight: 600;
            color: #102a6b;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-field {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .filter-field label {
            font-weight: 600;
            color: #28457a;
            font-size: 0.9rem;
        }

        .filter-field input {
            border: 1px solid rgba(33, 94, 201, 0.2);
            border-radius: 10px;
            padding: 0.6rem 0.75rem;
            font-size: 0.95rem;
            color: #1e2a45;
        }

        .filter-actions {
            display: flex;
            align-items: flex-end;
        }

        .primary-btn {
            background: linear-gradient(135deg, #2e6eff, #1b55d6);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 0.65rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(27, 85, 214, 0.25);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 0.65fr 0.35fr;
            gap: 1.5rem;
            align-items: stretch;
        }

        .dashboard-left {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .dashboard-right {
            display: flex;
            flex-direction: column;
        }

        .data-card {
            background: #f9fbff;
            border: 1px solid rgba(0, 86, 216, 0.18);
            border-radius: 12px;
            box-shadow: 0 14px 32px rgba(15, 35, 95, 0.08);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .panel-title {
            font-weight: 600;
            color: #003d99;
            font-size: 1.1rem;
            letter-spacing: 0.02em;
        }

        .chart-container-lg {
            position: relative;
            width: 100%;
            height: clamp(260px, 35vh, 360px);
        }

        .chart-container-lg .echart-surface {
            position: absolute;
            inset: 0;
        }

        .control-card {
            gap: 1rem;
        }

        .status-filter-wrapper label {
            font-weight: 600;
            color: #28457a;
            font-size: 0.9rem;
            margin-bottom: 0.35rem;
        }

        .status-filter-wrapper select {
            width: 100%;
            border: 1px solid rgba(33, 94, 201, 0.2);
            border-radius: 10px;
            padding: 0.65rem 0.75rem;
            background-color: #fff;
            font-size: 0.95rem;
        }

        .notes-box {
            background: rgba(15, 53, 140, 0.06);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            color: #2a4070;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .kpi-card {
            gap: 1.25rem;
        }

        .kpi-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }

        .donut-box {
            background: radial-gradient(circle at 50% 0%, #f4f8ff 0%, #eaf1ff 90%);
            border: 1px solid rgba(0, 86, 216, 0.18);
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(13, 40, 104, 0.12);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            gap: 0.35rem;
            min-height: 120px;
            text-align: center;
        }

        .control-box {
            align-items: stretch;
        }

        .donut-box-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            width: 100%;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: #1b55d6;
            font-size: 1.25rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .icon-btn:hover {
            transform: translateY(-2px);
        }

        .donut-percent {
            font-size: clamp(1.1rem, 1.9vw, 1.6rem);
            font-weight: 700;
            color: #001b4e;
        }

        .donut-label {
            font-size: clamp(0.85rem, 1.1vw, 1.05rem);
            color: #30497a;
            font-weight: 500;
        }

        .table-card {
            position: relative;
            overflow: hidden;
        }

        @@keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table-card .panel-title {
            margin-bottom: 0.75rem;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        #sumMaterialsTable {
            font-size: 0.85rem;
            color: #1e2a45;
        }

        #sumMaterialsTable th,
        #sumMaterialsTable td {
            white-space: nowrap;
        }

        #sumMaterialsTable th {
            background: #edf3ff;
            color: #0f2458;
            font-weight: 600;
        }

        #sumMaterialsTable tbody tr:nth-child(odd) {
            background: rgba(237, 243, 255, 0.45);
        }

        @@media (max-width: 1600px) {
            .dashboard-wrapper {
                transform: scale(0.95);
            }
        }

        @@media (max-width: 1400px) {
            .dashboard-wrapper {
                transform: scale(0.9);
            }
        }

        @@media (max-width: 1200px) {
            .dashboard-wrapper {
                transform: scale(0.85);
            }
        }

        @@media (max-width: 1024px) {
            .dashboard-wrapper {
                transform: scale(0.8);
            }
        }

        @@media (max-width: 900px) {
            .dashboard-wrapper {
                transform: scale(0.75);
            }
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const pickBtn = document.getElementById("pickDateBtn");

            const pad = (n) => String(n).padStart(2, "0");

            // format cho input datetime-local (LOCAL, không UTC)
            const toLocalInputValue = (d) =>
                `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

            // format cho API (LOCAL)
            const toApiParam = (d) =>
                `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;

            // parse từ chuỗi 'YYYY-MM-DDTHH:mm' (LOCAL) về Date an toàn (không bị UTC)
            const parseLocalInput = (s) => {
                const [date, time] = s.split("T");
                const [y, m, d] = date.split("-").map(Number);
                const [hh, mm] = time.split(":").map(Number);
                return new Date(y, m - 1, d, hh, mm, 0, 0);
            };

            // Khoảng mặc định: hôm qua 07:30 -> hiện tại
            const getDefaultRange = () => {
                const now = new Date();
                const from = new Date(now);
                from.setDate(now.getDate() - 1);
                from.setHours(7, 30, 0, 0);
                return { from, to: now };
            };

            // Lưu/đọc lựa chọn gần nhất
            const LS_KEY = "bonepile2_range";
            let currentFrom, currentTo;

            const loadSavedRange = () => {
                const raw = localStorage.getItem(LS_KEY);
                if (!raw) return false;
                try {
                    const obj = JSON.parse(raw);
                    currentFrom = new Date(obj.from); // lưu epoch/ISO đều ok, mình dùng Date để hiển thị LOCAL
                    currentTo = new Date(obj.to);
                    if (isNaN(currentFrom) || isNaN(currentTo)) return false;
                    return true;
                } catch { return false; }
            };
            const saveRange = () => {
                localStorage.setItem(LS_KEY, JSON.stringify({
                    from: currentFrom.getTime(), // lưu epoch để tránh lệch múi giờ
                    to: currentTo.getTime()
                }));
            };

            // API
            async function loadSummary(from, to) {
                try {
                    const url = `http://10.220.130.119:9090/api/Bonepile2/waiting-summary?from=${toApiParam(from)}&to=${toApiParam(to)}`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("API lỗi");
                    const data = await res.json();
                    document.getElementById("linkedDone").innerText = data.totals.linked;
                    document.getElementById("kanbanDone").innerText = data.totals.linkedKanban;
                } catch (err) {
                    Swal.fire("Lỗi", "Không lấy được dữ liệu: " + err.message, "error");
                }
            }

            // Khởi tạo currentFrom/currentTo (ưu tiên last selection, không có thì default)
            if (!loadSavedRange()) {
                const def = getDefaultRange();
                currentFrom = def.from;
                currentTo = def.to;
            }

            // Gọi API ngay lần đầu load với khoảng đang có
            loadSummary(currentFrom, currentTo);

            // SweetAlert2 chọn lại khoảng thời gian (giữ nguyên lần chọn trước)
            pickBtn.addEventListener("click", async () => {
                const { value: formValues } = await Swal.fire({
                    title: "Chọn khoảng thời gian",
                    html: `
                        <label style="display:block;text-align:left;">Từ:</label>
                        <input id="swalFrom" type="datetime-local" class="swal2-input"
                               value="${toLocalInputValue(currentFrom)}">
                        <label style="display:block;text-align:left;">Đến:</label>
                        <input id="swalTo" type="datetime-local" class="swal2-input"
                               value="${toLocalInputValue(currentTo)}">
                      `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: "Áp dụng",
                    cancelButtonText: "Hủy",
                    preConfirm: () => {
                        const fromVal = document.getElementById("swalFrom").value;
                        const toVal = document.getElementById("swalTo").value;
                        if (!fromVal || !toVal) {
                            Swal.showValidationMessage("Vui lòng chọn đủ thời gian!");
                            return false;
                        }
                        const f = parseLocalInput(fromVal);
                        const t = parseLocalInput(toVal);
                        if (isNaN(f) || isNaN(t)) {
                            Swal.showValidationMessage("Thời gian không hợp lệ!");
                            return false;
                        }
                        if (t <= f) {
                            Swal.showValidationMessage("`Đến` phải lớn hơn `Từ`!");
                            return false;
                        }
                        return { f, t };
                    }
                });

                if (formValues) {
                    currentFrom = formValues.f;
                    currentTo = formValues.t;
                    saveRange();                 // lưu lại để lần sau mở popup giữ đúng
                    await loadSummary(currentFrom, currentTo);
                }
            });
        });
    </script>
}
